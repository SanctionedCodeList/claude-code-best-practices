# Advanced Skill Development Tools

This reference covers optional tooling for complex skill development: template composition, structure validation, and sitemap generation.

## Table of Contents

- [Template Build System](#template-build-system)
- [Structure Validation](#structure-validation)
- [Knowledge Base Mode](#knowledge-base-mode)
- [Sitemap Generation](#sitemap-generation)

## Template Build System

For skills with composable content (shared fragments, reusable sections), use Jinja2 templates:

```bash
scripts/build.py --root /path/to/skill           # Build all templates
scripts/build.py --root /path/to/skill --clean   # Clean rebuild
scripts/build.py --root /path/to/skill --check   # Check if rebuild needed (for CI)
```

**Convention:**
- Templates use `.md.j2` extension adjacent to their outputs
- `foo.md.j2` generates `foo.md` with an AUTO-GENERATED header
- Use `{% include 'path/to/fragment.md' %}` to compose content
- Files without `.j2` are editable directly

**Example structure:**
```
my-skill/
├── SKILL.md
├── styles/
│   └── formal.md           # Reusable style (editable)
├── structures/
│   ├── report.md.j2        # Template (edit this)
│   └── report.md           # Generated (don't edit)
└── _includes/
    └── citations.md        # Internal fragment
```

**Template example:**
```jinja
---
name: "report"
description: "Formal report structure"
---

# Report

{% include 'styles/formal.md' %}
{% include '_includes/citations.md' %}

## Structure
...
```

## Structure Validation

Validate skill structure for navigability and consistency:

```bash
scripts/structure_validate.py --root /path/to/skill              # Run all checks
scripts/structure_validate.py --root /path/to/skill --focus sub  # Check subdirectory
scripts/structure_validate.py --root /path/to/skill --graph      # Output mermaid diagram
scripts/structure_validate.py --root /path/to/skill -v           # Verbose with stats
```

**Standard checks:**
1. **Broken links** - Links to non-existent files
2. **Orphan files** - `.md` files with no incoming links
3. **Depth limits** - Files too deep in the hierarchy (default: 3 levels)
4. **Generated headers** - Files from `.j2` templates have AUTO-GENERATED headers
5. **File length** - Files exceeding recommended limits (warning: 300, error: 500 lines)

**Configuration via `.validate.json`:**
```json
{
  "max_depth": 3,
  "max_lines_warning": 300,
  "max_lines_error": 500,
  "excluded_patterns": ["_includes/", "assets/", "scripts/"],
  "known_issues": {
    "broken_links": ["reference/external/"],
    "long_files": ["reference/tables/"]
  }
}
```

## Knowledge Base Mode

For knowledge base skills (see [knowledge-base-skills.md](knowledge-base-skills.md)), enable additional checks with `--km`:

```bash
scripts/structure_validate.py --root /path/to/skill --km
```

**Additional KM checks:**
1. **Index files** - Every folder has `index.md` (except exception folders prefixed with `_`)
2. **Links sections** - Index files have `## Links` section with descriptions
3. **Horizontal rules** - No `---` in content (use headings instead)
4. **Naming conventions** - Files use lowercase with hyphens (not underscores)

**Enable KM mode via config:**
```json
{
  "km_mode": true
}
```

**Example output:**
```
Validating my-skill skill [knowledge base mode]...

✅ No broken links
✅ No orphan files
✅ All files within depth 3
✅ All generated files have headers
✅ All files within 300 lines

--- Knowledge Base Checks ---
✅ All folders have index.md
✅ All index files have proper ## Links sections
✅ No horizontal rules in content
✅ All files follow naming conventions

────────────────────────────────────────
✅ All checks passed!
```

## Sitemap Generation

Generate a hierarchical sitemap of skill contents:

```bash
scripts/sitemap.py --root /path/to/skill                    # Print to stdout
scripts/sitemap.py --root /path/to/skill -o SITEMAP.md      # Write to file
scripts/sitemap.py --root /path/to/skill --include-exceptions  # Include _* folders
```

**Features:**
- Extracts descriptions from `## Links` sections for each file
- Falls back to first paragraph if no link description found
- Marks index files in bold
- Excludes exception folders (`_*`) by default
- Produces clean markdown hierarchy

**Example output:**
```markdown
# Sitemap

Knowledge base structure for `my-skill/`

Exception folders (`_*`) are searchable reference materials, not shown here.

- **[My Skill](SKILL.md)** - Main skill description from frontmatter
- `law/`
  - **[Law](law/index.md)** - Legal doctrine and rules
  - [Section 101](law/section-101.md) - Patent eligibility framework
  - [Section 112](law/section-112.md) - Disclosure requirements
- `advocacy/`
  - **[Advocacy](advocacy/index.md)** - How to argue legal positions
  - [Eligibility Arguments](advocacy/eligibility.md) - Attack and defense patterns

*Generated by sitemap.py*
```

**Integration with validation:**

After making changes, regenerate sitemap and validate:
```bash
scripts/sitemap.py --root /path/to/skill -o /path/to/skill/SITEMAP.md
scripts/structure_validate.py --root /path/to/skill --km
```

## Best Practices

- Keep files under 300 lines for readability and context efficiency
- Ensure all content files are reachable from SKILL.md
- Use `--graph` to visualize skill structure as a mermaid diagram
- Run validation before committing changes
- For knowledge bases, run with `--km` to catch navigation issues
- Regenerate sitemap when structure changes
